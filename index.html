<!DOCTYPE html>
<html lang="en">

<head>
    <title>Udacity Todos Goals</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/redux/4.1.2/redux.min.js"></script>
    <script src="https://unpkg.com/react@17.0.2/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17.0.2/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone@7.17.6/babel.min.js"></script>
    <script src="https://tylermcginnis.com/goals-todos-api/index.js"></script>
</head>

<body>
<div id="app"></div>

<script src="scripts.js"></script>
<script type="text/babel">
    const store = Redux.createStore(
        Redux.combineReducers({
            todos,
            goals,
            loading,
        }),
        Redux.applyMiddleware(checker, logger)
    );

    const App = (props) => {
        const [value, setValue] = React.useState(0)

        React.useEffect(() => {
            Promise.all([API.fetchTodos(), API.fetchGoals()]).then(([todos, goals]) => {
                props.store.dispatch(receiveDataActions(todos, goals))
            });
        }, []);

        React.useEffect(() => {
            props.store.subscribe(
                () => {
                    setValue(value => value + 1)
                });
        }, []);

        const {todos, goals, loading} = props.store.getState()

        if (loading === true) {
            return <h3>Loading</h3>
        }

        return (
            <div>
                <Todos todos={todos} store={props.store}/>
                <Goals goals={goals} store={props.store}/>
            </div>
        )
    }

    const List = (props) => {
        return (
            <ul>
                {props.items && props.items.map((item) => {
                    return (
                        <li key={item.id}>
                            <span
                                style={{
                                    textDecoration: item.complete ? "line-through" : "none"
                                }}
                                onClick={() => props.toggle && props.toggle(item)}>{item.name}</span>
                            <button onClick={() => props.remove(item)}>X</button>
                        </li>
                    )
                })}
            </ul>
        )
    };

    const Todos = (props) => {
        const inputRef = React.useRef();

        const addItem = (event) => {
            event.preventDefault();

            API.saveTodo(inputRef.current.value).then((todo) => {
                props.store.dispatch(addTodoAction(todo))
                inputRef.current.value = "";
            }).catch(() => {
                alert("There was an error. Try again.")
            });
        }

        const removeItem = todo => {
            props.store.dispatch(removeTodoAction(todo.id));

            return API.deleteTodo(todo.id).catch(() => {
                props.store.dispatch(addTodoAction(todo));
                alert("An error occurred. Try again")
            });
        }

        const toggleItem = todo => {
            props.store.dispatch(toggleTodoAction(todo.id));

            return API.saveTodoToggle(todo.id).catch(() => {
                props.store.dispatch(toggleTodoAction(todo.id));
                alert("An error occurred. Try again")
            });
        }

        return (
            <div>
                <h3>Todo List</h3>
                <input type="text" placeholder="Add Todo" ref={inputRef}/>
                <button onClick={addItem}>Add Todo</button>
                <List remove={removeItem} toggle={toggleItem} items={props.todos}/>
            </div>
        )
    }

    const Goals = (props) => {
        const inputRef = React.useRef();

        const addItem = (event) => {
            event.preventDefault();

            API.saveGoal(inputRef.current.value).then((goal) => {
                props.store.dispatch(addGoalAction(goal))
                inputRef.current.value = "";
            }).catch(() => {
                alert("There was an error. Try again.")
            });
        }

        const removeItem = goal => {
            props.store.dispatch(removeGoalAction(goal.id));

            return API.deleteGoal(goal.id).catch(() => {
                props.store.dispatch(addGoalAction(goal));
                alert("An error occurred. Try again")
            });
        }

        const toggleItem = goal => {
            props.store.dispatch(toggleTodoAction(goal.id));
        }

        return (
            <div>
                <h3>Goals</h3>
                <input type="text" placeholder="Add Goal" ref={inputRef}/>
                <button onClick={addItem}>Add Todo</button>
                <List remove={removeItem} toggle={toggleItem} items={props.goals}/>
            </div>
        )
    }

    ReactDOM.render(<App store={store}/>, document.getElementById('app'))
</script>
</body>

</html>